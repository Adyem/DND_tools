#include "character.h"
#include "dnd_tools.h"
#include "libft/libft/libft.h"

void ft_initiative_remove(t_char *info)
{
	char	**content;
	int		i;
	int		fd;

	content = ft_open_and_read("data/data--initiative");
	if (!content)
		return ;
	i = 0;
	fd = open("data/data--initiative", O_WRONLY | O_CREAT | O_TRUNC,
		S_IRUSR | S_IWUSR);
	if (fd == -1)
	{
		ft_printf_fd(2, "270-Error opening file: %s\n", strerror(errno));
		ft_free_content(content);
		return ;
	}
	i = 0;
	while (content[i])
	{
		if ((ft_strncmp(info->name, content[i], ft_strlen(info->name)) == 0)
				&& (ft_strlen(content[i]) > ft_strlen(info->name))
				&& (content[i][ft_strlen(info->name) + 1] == '='))
		{
			i++;
			continue ;
		}
		ft_printf_fd(fd, "%s", content[i]);
		i++;
	}
	close(fd);
    ft_free_content(content);
	return ;
}

static int ft_initiative_check(t_char *info, char **content)
{
    int i;

    i = 0;
    while (content[i])
    {
        if (ft_strncmp(content[i], info->name, ft_strlen(info->name)))
            return (1);
        i++;
    }
    return (0);
}

void ft_initiative_add(t_char *info)
{
	char	**content;
	int		i;
	int		fd;
	int		added;
	int		initiative;

	content = ft_open_and_read("data/data--initiative");
	if (!content)
		return ;
	i = 0;
	fd = open("data/data--initiative", O_WRONLY | O_CREAT | O_TRUNC,
		S_IRUSR | S_IWUSR);
	if (fd == -1)
	{
		ft_printf_fd(2, "270-Error opening file: %s\n", strerror(errno));
		ft_free_content(content);
		return ;
	}
    added = 0;
	i = 0;
	while (content[i])
	{
		if (!added && (sscanf(content[i], "%*[^=]=%d", &initiative) == 1)
				&& (initiative > info->initiative)
                && (ft_initiative_check(info,  content) == 0))
		{
			ft_printf_fd(fd, "%s=%d\n", info->name, info->initiative);
			added = 1;
		}
		ft_printf_fd(fd, "%s", content[i]);
		i++;
	}
	close(fd);
    ft_free_content(content);
	return ;
}
